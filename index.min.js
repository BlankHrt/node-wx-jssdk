const request=require("request"),WXBizDataCrypt=require("./lib/WXBizDataCrypt"),md5=require("./lib/md5"),randomstring=require("randomstring"),{parseString}=require("xml2js");let WX={login:({code:t,appid:r,secret:n})=>new Promise((a,i)=>{var e;t&&r&&n?(e="?grant_type=authorization_code&appid="+r+"&secret="+n+"&js_code="+t,request.get("https://api.weixin.qq.com/sns/jscode2session"+e,(e,t,r)=>{e&&i(e),a(r)})):i({error:"请传递正确参数"})}),decrypt:({appid:a,session_key:i,encryptedData:n,iv:o})=>new Promise((e,t)=>{if(a&&i&&n&&o){const r=new WXBizDataCrypt(a,i);e(r.decryptData(n,o))}else t({error:"请传递正确参数"})})};const pad2=e=>e<10?"0"+e:e,pad3=e=>e<10?"00"+e:e<100?"0"+e:e,generateNumber=()=>{var e=new Date;return e.getFullYear().toString()+pad2(e.getMonth()+1)+pad2(e.getDate())+pad2(e.getHours())+pad2(e.getMinutes())+pad3(e.getMilliseconds())+Math.round(Math.random()*2**30).toString().substr(2,5)},get_client_ip=e=>{e=e.headers["x-forwarded-for"]||e.ip||e.connection.remoteAddress||e.socket.remoteAddress||e.connection.socket.remoteAddress||"";return e=0<e.split(",").length?e.split(",")[0]:e};WX.pay=({appid:s,body:e,mch_id:t,notify_url:r,openid:a,spbill_create_ip:i,total_fee:p,KEY:d})=>{var n=req.body,o=generateNumber();const c=randomstring.generate({charset:"alphanumeric",length:16}),l={appid:s,body:e,mch_id:t,nonce_str:c,notify_url:r,openid:a,out_trade_no:o,spbill_create_ip:i,total_fee:p,trade_type:"JSAPI"};var m="";for(u of Object.keys(l).sort())l[u]&&(m+="&"+u+"="+l[u]);var g,m=m.slice(1)+"&key="+d;g=("HMAC-SHA256"==(n.sign_type||"MD5")?g=hmac_sha256(m,wkey)+"":md5(m)).toUpperCase(),l.sign=g;var u,y="<xml>";for(u in l)l[u]&&(y+="<"+u+">"+l[u]+"</"+u+">");return y+="</xml>",new Promise((n,o)=>{request.post({url:"https://api.mch.weixin.qq.com/pay/unifiedorder",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:y},(i,e,t)=>{parseString(t,{trim:!0},(e,t)=>{var r=t.xml.prepay_id[0],a=Math.ceil((new Date).getTime()/1e3)+"",t="appId="+s+"&nonceStr="+c+"&package=prepay_id="+r+"&signType=MD5&timeStamp="+a+"&key="+d,t=md5(t).toUpperCase(),t={nonceStr:c,package:"prepay_id="+r,timeStamp:a,paySign:t,total_fee:p,signType:"MD5",number:number};i&&o(i),n(t)})})})},WX.getAccessToken=({appid:t,secret:r})=>new Promise((a,i)=>{var e;t&&r?(e="?grant_type=client_credential&appid="+t+"&secret="+r,request.get("https://api.weixin.qq.com/cgi-bin/token"+e,(e,t,r)=>{e&&i(e),a(r)})):i({error:"请传递正确参数"})}),WX.generateQrcode=({scene:e,page:t,access_token:r})=>{var n=JSON.stringify({scene:e,page:t,width:430,auto_color:!1,line_color:{r:"0",g:"0",b:"0"},is_hyaline:!1});return new Promise((a,i)=>{request.post({url:`https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=${r}`,headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n},(e,t,r)=>{e&&i(e),a(r)})})},module.exports=WX;