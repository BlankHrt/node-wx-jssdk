const request=require("request"),WXBizDataCrypt=require("./lib/WXBizDataCrypt"),md5=require("./lib/md5"),randomstring=require("randomstring"),{parseString}=require("xml2js");let wx={login:({code:t,appid:r,secret:n})=>new Promise((i,a)=>{var e;t&&r&&n?(e="?grant_type=authorization_code&appid="+r+"&secret="+n+"&js_code="+t,request.get("https://api.weixin.qq.com/sns/jscode2session"+e,(e,t,r)=>{e&&a(e),i(r)})):a({error:"请传递正确参数"})}),decrypt:({appid:i,session_key:a,encryptedData:n,iv:o})=>new Promise((e,t)=>{if(i&&a&&n&&o){const r=new WXBizDataCrypt(i,a);e(r.decryptData(n,o))}else t({error:"请传递正确参数"})})};const pad2=e=>e<10?"0"+e:e,pad3=e=>e<10?"00"+e:e<100?"0"+e:e,generateNumber=()=>{var e=new Date;return e.getFullYear().toString()+pad2(e.getMonth()+1)+pad2(e.getDate())+pad2(e.getHours())+pad2(e.getMinutes())+pad3(e.getMilliseconds())+Math.round(Math.random()*2**30).toString().substr(2,5)},get_client_ip=e=>{e=e.headers["x-forwarded-for"]||e.ip||e.connection.remoteAddress||e.socket.remoteAddress||e.connection.socket.remoteAddress||"";return e=0<e.split(",").length?e.split(",")[0]:e};wx.pay=({appid:p,body:e,mch_id:t,notify_url:r,openid:i,spbill_create_ip:a,total_fee:s,KEY:d})=>{var n=req.body,o=generateNumber();const c=randomstring.generate({charset:"alphanumeric",length:16}),l={appid:p,body:e,mch_id:t,nonce_str:c,notify_url:r,openid:i,out_trade_no:o,spbill_create_ip:a,total_fee:s,trade_type:"JSAPI"};var m="";for(u of Object.keys(l).sort())l[u]&&(m+="&"+u+"="+l[u]);var g,m=m.slice(1)+"&key="+d;g=("HMAC-SHA256"==(n.sign_type||"MD5")?g=hmac_sha256(m,wkey)+"":md5(m)).toUpperCase(),l.sign=g;var u,y="<xml>";for(u in l)l[u]&&(y+="<"+u+">"+l[u]+"</"+u+">");return y+="</xml>",new Promise((n,o)=>{request.post({url:"https://api.mch.weixin.qq.com/pay/unifiedorder",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:y},(a,e,t)=>{parseString(t,{trim:!0},(e,t)=>{var r=t.xml.prepay_id[0],i=Math.ceil((new Date).getTime()/1e3)+"",t="appId="+p+"&nonceStr="+c+"&package=prepay_id="+r+"&signType=MD5&timeStamp="+i+"&key="+d,t=md5(t).toUpperCase(),t={nonceStr:c,package:"prepay_id="+r,timeStamp:i,paySign:t,total_fee:s,signType:"MD5",number:number};a&&o(a),n(t)})})})},wx.getAccessToken=({appid:t,secret:r})=>new Promise((i,a)=>{var e;t&&r?(e="?grant_type=client_credential&appid="+t+"&secret="+r,request.get("https://api.weixin.qq.com/cgi-bin/token"+e,(e,t,r)=>{e&&a(e),i(r)})):a({error:"请传递正确参数"})}),generateQrcode=(e,t,r)=>{var n=JSON.stringify({scene:e,page:t,width:430,auto_color:!1,line_color:{r:"0",g:"0",b:"0"},is_hyaline:!1});return new Promise((i,a)=>{request.post({url:`https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=${r}`,headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n},(e,t,r)=>{e&&a(e),i(r)})})},module.exports=wx;